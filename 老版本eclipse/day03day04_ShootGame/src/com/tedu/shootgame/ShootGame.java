package com.tedu.shootgame;

import java.awt.Graphics;
import java.awt.Toolkit;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.awt.image.BufferedImage;
import java.util.Arrays;
import java.util.Random;
import java.util.Timer;
import java.util.TimerTask;

import javax.swing.JFrame;
import javax.swing.JPanel;

/**
 * 上帝类--主类
 * @author 123
 *
 */
public class ShootGame extends JPanel {
	//窗体的属性
	public static int width=Toolkit.getDefaultToolkit().getScreenSize().width;
	public static int height=Toolkit.getDefaultToolkit().getScreenSize().height;
	//窗体的宽
	public static final int WIDTH=400;
	public static final int HEIGHT=700;
	//水平居中x坐标
	public static int jframeX=width/2-WIDTH/2;
	//垂直居中y坐标
	public static int jframeY=height/2-HEIGHT/2;
	/*
	 * 设置游戏状态
	 * 启动、运行、暂停、结束
	 * 默认为启动
	 * 
	 */
	//启动
	public static final int START=0;
	//运行
	public static final int RUNNING=1;
	//暂停
	public static final int PAUSE=2;
	//结束
	public static final int GAME_OVER=3;
	//游戏当前的状态
	public int state = START;
	//定义图片集
	public static BufferedImage start;
	//暂停图
	public static BufferedImage pause;
	//结束图
	public static BufferedImage gameOver;

	/*使用静态代码块加载图片*/
	static{
		//开始图片
		start=FlyingObject.loadImage("start.png");
		//暂停图片
		pause=FlyingObject.loadImage("pause.png");
		//结束图片
		gameOver=FlyingObject.loadImage("gameover.png");
	}
	/*定义实体类*/
	private Sky sky=new Sky();
	private Hero hero=new Hero();
	/*大小敌机和蜜蜂*/
	private FlyingObject[] enemies={};
	private Bullet[] bullets={};
	/*生成敌人的核心算法*/
	public FlyingObject nextOne(){
		/*实例化随机数对象*/
		Random rand=new Random();
		//产生20范围内随机数
		int type=rand.nextInt(20);
		if (type<4) {
			return new Bee();
		}else if (type<12) {
			return new Airplane()
;		}else{
	return new BigAirplane();
	}
}
	/*定义敌人的入场计数器*/
	int enterIndex=0;
	/*大小敌机和蜜蜂入场*/
	public void enterAction(){
		enterIndex ++;//每十毫秒加一
		if (enterIndex%40==0) {//每0.4秒产生一个飞行物
			//获取敌人对象
			FlyingObject obj=nextOne();
			//数组的扩容
			enemies=Arrays.copyOf(enemies, enemies.length+1);
			//将产生的敌人放在数组中-最后
			enemies[enemies.length-1]=obj;
		}
	}
	/*定义子弹入场计数器*/
	int shootIndex=0;
	//子弹入场-英雄机发射子弹
	public void shootAction(){
		shootIndex ++;
		if (shootIndex%30==0) {
			Bullet[] bs=hero.shoot();
			bullets=Arrays.copyOf(bullets, bullets.length+bs.length);
			//数组的追加
			System.arraycopy(bs, 0, bullets, bullets.length-bs.length, bs.length);
			
		}
	}
	 /*飞行物的移动*/
	public void stepAction(){
		//天空移动
		sky.step();
		//英雄机移动	
		hero.step();
		//敌人移动
		for (int i = 0; i < enemies.length; i++) {
			enemies[i].step();
		}
		//子弹移动
		for (int i = 0; i < bullets.length; i++) {
			bullets[i].step();
		}
	}
	/*删除越界的飞行物*/
	public void outOfBoundsAction(){
		//定义没有越界飞行物下标
		int index=0;
		//定义没有越界飞行物数组
		FlyingObject[] enemyLives=new FlyingObject[enemies.length];
		//遍历敌人数组
		for (int i = 0; i < enemies.length; i++) {
			//获取每一个敌人
			FlyingObject f=enemies[i];
			if (!f.OutOfBounds()) {
				//将不越界的敌人存入不越界数组
				enemyLives[index]=f;
				index ++;//下标和个数
			}
		}
		//将不越界的敌人数组复制到enemies
		enemies=Arrays.copyOf(enemyLives, index);
		//定义不越界的子弹下标
		index=0;
		//不越界的子弹数组
		Bullet[] bulletLives = new Bullet[bullets.length];
		//遍历子弹数组
		for (int i = 0; i < bullets.length; i++) {
			Bullet b=bullets[i];
			if (!b.OutOfBounds()) {
				bulletLives[index]=b;
				index++;
			}
		}
		bullets=Arrays.copyOf(bulletLives, index);
		
	}
	
	/*定义玩家得分*/
	int score=0;
	/*敌人鱼子弹碰撞分数*/
	public void bulletBangAction(){
		//遍历所有的子弹
		for (int i = 0; i < bullets.length; i++) {
			//获取每一颗子弹
			Bullet b= bullets[i];
			//遍历所有的敌人
			for (int j = 0; j < enemies.length; j++) {
				//获取每一个敌人
				FlyingObject f=enemies[j];
				//判断是否碰撞
				if (f.hit(b)&&f.isLife()&&b.isLife()) {
					f.goDead();//敌人去死
					b.goDead();//子弹去死
					//碰撞之后判断类型
					if (f instanceof Enemy) {//instanceof判断是否是一种类型，是否一致
						//将父类型强制转化
						Enemy en=(Enemy)f;
						//大小敌机得分
						score +=en.getScore();
					}
					if (f instanceof Award) {
						//将父类型转化
						Award aw=(Award)f;
						//获取到奖励类型
						int type=aw.getAwardType();
						switch (type) {
						case Award.DOUBLE_FIRE:
							//英雄机变双倍火力
							hero.addDoubleFire();
							break;
						case Award.LIFE:
							hero.addLife();
							break;
						}
					
					}
					
				}
			}
		}
	}
	//英雄机与敌人碰撞
	public void heroBangAction(){
		//遍历所有的敌人
		for (int i = 0; i < enemies.length; i++) {
			//
			FlyingObject f=enemies[i];
			//判断是否撞上
			if (f.hit(hero)&&f.isLife()&&hero.isLife()) {
				f.goDead();
				hero.subtractLife();
				hero.clearDoubleFire();
			}
		}
	}
	//检测游戏是否结束
	public void checkGameOverAction(){
		//生命值小于等于0
		if (hero.getLife()<=0) {
			state=GAME_OVER;
			
		}
	}
	/*启动执行程序*/
	public void action() {
		//创建监听器对象
		MouseAdapter l=new MouseAdapter(){
			/*重写MouseMove方法*/
			public void mouseMoved(MouseEvent e) {
				//运行状态
				if (state==RUNNING) {
					int x=e.getX();
					int y=e.getY();
					hero.moveTo(x, y);
					
				}
			}
			/*重写鼠标点击事件*/
			public void mouseClicked(MouseEvent e) {
				//根据不同的状态做出不同的处理
				switch (state) {
				case START:
					state=RUNNING;
					break;
				case GAME_OVER:
					score=0;
					sky=new Sky();
					hero=new Hero();
					enemies=new FlyingObject[0];
					bullets=new Bullet[0];
					state=START;
					break;
				}
			}
			/*重写鼠标移出事件*/
			public void mouseExited(MouseEvent e) {
				if (state==RUNNING) {
					state=PAUSE;
				}
			}
			/*重写鼠标移入事件*/
			public void mouseEntered(MouseEvent e) {
				if (state==PAUSE) {
					state = RUNNING;
					
				}
			}
		};
		//添加鼠标操作事件
		this.addMouseListener(l);
		//添加鼠标滑动事件
		this.addMouseMotionListener(l);
		//定义定时器对象
		Timer timer=new Timer();
		int intervel=10;//10ms间隔
		timer.schedule(new TimerTask(){
			//重写定时任务run方法
			public void run() {
				//定时任务10毫秒走一次
				if (state==RUNNING) {
					/*大小敌机蜜蜂入场*/
					enterAction();
					/*子弹入场*/
					shootAction();
					/*飞行物移动*/
					stepAction();
					/*删除越界飞行物*/
					outOfBoundsAction();
					/*子弹与敌人碰撞*/
					bulletBangAction();
					/*英雄机与敌人碰撞*/
					heroBangAction();
					/*检测游戏是否结束*/
					checkGameOverAction();
				}
				repaint();

			}
			
		}, intervel, intervel);
		
	}
	/*重写判定方法*/
	@Override
	public void paint(Graphics g) {
		sky.paintObject(g);
		hero.paintObject(g);
		for (int i = 0; i < enemies.length; i++) {
			enemies[i].paintObject(g);
		}
		for (int i = 0; i < bullets.length; i++) {
			bullets[i].paintObject(g);
		}
		/*画得分版*/
		g.drawString("SCORE:"+score, 10, 25);
		/*画生命值*/
		g.drawString("LIFE:"+hero.getLife(), 10, 45);
		/*画不同状态下的状态图*/
		switch (state) {
		case START:
			g.drawImage(start, 0, 0, null);
			break;
		case PAUSE:
			g.drawImage(pause, 0, 0, null);
			break;
		case GAME_OVER:
			g.drawImage(gameOver, 0, 0, null);
			break;
		}
	}
	public static void main(String[] args) {
		/*实例化窗体对象*/
		JFrame jf=new JFrame();
		/*设置标题*/
		jf.setTitle("");
		ShootGame sg=new ShootGame();
		jf.add(sg);
		jf.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
		jf.setBounds(jframeX,jframeY,WIDTH,HEIGHT);
		jf.setVisible(true);
		sg.action();
		new Music().start();
	}

}






